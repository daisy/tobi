<DockPanel
    x:Class="Tobi.Plugin.MetadataPane.MetadataPaneView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="clr-namespace:Tobi.Plugin.MetadataPane"
    xmlns:UI="clr-namespace:Tobi.Common.UI;assembly=Tobi.Common"
    xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
    xmlns:dat="clr-namespace:System.Windows.Data;assembly=PresentationFramework"
    LastChildFill="True">
  <!-- ALL RESOURCES -->
  <DockPanel.Resources>

    <!-- COLLECTION VIEW SOURCE for Metadata objects, sorted by required vs recommended/optional -->
    <CollectionViewSource Source="{Binding Path=MetadataCollection.Metadatas}" x:Key="MetadatasCVS">
      <CollectionViewSource.SortDescriptions>
        <scm:SortDescription PropertyName="Definition.Occurrence" Direction="Ascending"/>
        <scm:SortDescription PropertyName="Name" />
      </CollectionViewSource.SortDescriptions>
    </CollectionViewSource>

    <Style TargetType="{x:Type ListView}">
      <Setter Property="BorderBrush" Value="Black"/>
    </Style>

    <Style TargetType="{x:Type ListViewItem}">
      <Setter Property="Margin" Value="4"/>
      <Setter>
        <Setter.Property>AutomationProperties.Name</Setter.Property>
        <Setter.Value>
          <MultiBinding Converter="{local:FullDescriptionConverter}">
            <Binding Path="Name"/>
            <Binding Path="Content"/>
          </MultiBinding>
        </Setter.Value>
      </Setter>
      <Style.Triggers>
        <Trigger Property="ItemsControl.AlternationIndex" Value="0">
          <Setter Property="Background"
                  Value="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <DataTemplate x:Key="AddNewPopup">
      <StackPanel>
        <TextBlock Text="Content"/>
        <TextBox Text="{Binding Mode=TwoWay, Path=Content}"/>
      </StackPanel>
    </DataTemplate>

    
  </DockPanel.Resources>

  <Grid Height="Auto" Width="Auto">
    <!-- split the screen into two columns of equal size -->
    <Grid.RowDefinitions>
      <RowDefinition Height="5*"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <ListView
      Grid.Row="0"
      AlternationCount="2"
      ItemsSource="{Binding Source={StaticResource MetadatasCVS}}"
      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
      HorizontalContentAlignment="Stretch"
      IsSynchronizedWithCurrentItem="True">
      <ListView.View>
        <GridView>
          
          <GridViewColumn Header="Name" DisplayMemberBinding="{Binding Name}" Width="Auto"/>
          
          <GridViewColumn Header="Content"  Width="Auto">
            <GridViewColumn.CellTemplate>
              <DataTemplate>
                <TextBox x:Name="contentText" 
                         Text="{Binding 
                         Mode=TwoWay, 
                         Path=Content, 
                         UpdateSourceTrigger=PropertyChanged}"
                         />
              </DataTemplate>
            </GridViewColumn.CellTemplate>
          </GridViewColumn>
          
          <GridViewColumn  Width="Auto" Header="Occurrence" DisplayMemberBinding="{Binding Definition, 
                          Converter={local:OccurrenceDescriptionConverter}}"/>

          <GridViewColumn Header="Errors">
            <GridViewColumn.CellTemplate>
              <DataTemplate>
                <!-- default: show no text -->
                <TextBlock x:Name="errorText" Text="" TextWrapping="Wrap"  MinWidth="150"/>

                <DataTemplate.Triggers>
                  <DataTrigger Value="False">
                      <DataTrigger.Binding>
                        <!-- if there is an error -->
                        <MultiBinding Converter="{local:ValidityConverter}">
                          <MultiBinding.Bindings>
                            <Binding/>
                            <Binding RelativeSource="{RelativeSource FindAncestor, AncestorType={x:Type local:MetadataPaneView}}"
                                     Path="DataContext.ValidationItems"/>
                          </MultiBinding.Bindings>
                        </MultiBinding>
                      </DataTrigger.Binding>
                      
                      <!-- set the error text -->
                      <Setter TargetName="errorText" Property="Text">
                        <Setter.Value>

                          <MultiBinding Converter="{local:DescriptiveErrorTextConverter}">
                            <Binding/>
                            <Binding RelativeSource="{RelativeSource FindAncestor,
                                       AncestorType={x:Type local:MetadataPaneView}}"
                                     Path="DataContext.ValidationItems"/>
                          </MultiBinding>
                        </Setter.Value>
                      </Setter>
                      
                    </DataTrigger>
                  </DataTemplate.Triggers>
                
              </DataTemplate>
            </GridViewColumn.CellTemplate>
          </GridViewColumn> 
          
          <GridViewColumn  Width="Auto">
            <GridViewColumn.CellTemplate>
              
              <DataTemplate>
                <Button x:Name="deleteButton" Content="Delete" Click="DeleteButton_OnClick"/>
                <!-- the delete button is not enabled for required items-->
                <DataTemplate.Triggers>
                  <DataTrigger Value="False"
                               Binding="{Binding Converter={local:IsNotRequiredOccurrenceConverter}}">

                    <Setter TargetName="deleteButton" Property="Visibility" Value="Hidden"/>

                  </DataTrigger>
                </DataTemplate.Triggers>
              </DataTemplate>
            </GridViewColumn.CellTemplate>
          </GridViewColumn>
          <GridViewColumn Header="Is primary identifier?">
            <GridViewColumn.CellTemplate>
              <DataTemplate>
                <CheckBox Visibility="{Binding Converter={local:PrimaryIdentifierConverter}}"
                        IsChecked="{Binding IsPrimaryIdentifier, Mode=TwoWay}"/>
              </DataTemplate>
            </GridViewColumn.CellTemplate>
          </GridViewColumn>
        </GridView>
      </ListView.View>
    </ListView>
    
    <Button Content="Add a new metadata item" HorizontalAlignment="Left" Grid.Row="1" Width="Auto" Margin="5"/>

    <StackPanel Grid.Row="2">
      <TextBlock Text="Description:" FontWeight="Bold"/>
      <TextBlock TextWrapping="Wrap" Text="{Binding Source={StaticResource MetadatasCVS}, Path=/Definition.Description}"/>
    </StackPanel>
    
  </Grid>
</DockPanel>

